:- import incr_assert/1,incr_retractall/1,incr_assert_inval/1,
	  incr_table_update/0,incr_retract_inval/1 from increval.


/* This prevents a spurious error for executing incremental under the
    mt engine, which does not yet support incremental tabling. */
test:- 
	(xsb_configuration(engine_mode,'multi-threading') -> 
	    load_dync(inc_atc_old),
	    (incr(X),write(incr(X)),writeln('.'),fail ; true)
	 ;  test_seq).

test_seq:- test1,fail.
test_seq:- test2.

% direct dependency
test1:- p(X,Y),incr_writeln(first_p(X,Y)),fail.
test1:- incr_assert(q(d,4)),fail.
test1:- p(X,Y),incr_writeln(second_p(X,Y)),fail.
test1:- incr_retractall(q(a,_X)),fail.
test1:- p(X,Y),incr_writeln(third_p(X,Y)),fail.
test1:- incr_retract_inval(q(b,_X)),fail.
test1:- get_residual(p(X,Y),_),incr_writeln(fourth_p(X,Y)),fail.
test1:- incr_table_update,get_residual(p(X,Y),_),incr_writeln(fifth_p(X,Y)),fail.
test1:- incr_assert_inval(q(e,2)),fail.
test1:- get_residual(p(X,Y),_),incr_writeln(sixth_p(X,Y)),fail.
test1:- incr_table_update,get_residual(p(X,Y),_),incr_writeln(seventh_p(X,Y)),fail.
test1.

% transitive dependency
test2:- n(X,Y),incr_writeln(first_n(X,Y)),fail.
test2:- abolish_table_call(n(_X,_Y)),fail.
test2:- incr_assert(q(f,4)),fail.
test2:- n(X,Y),incr_writeln(second_n(X,Y)),fail.
test2.

incr_writeln(Term):- write(incr(Term)),writeln('.').


%:- table p/2 as incremental.
:- table p/2.
:- use_incremental_tabling p/2.

p(X,Y) :- q(X,Y),Y =< 5.

:- table n/2.
:- use_incremental_tabling n/2.
n(X,Y) :- p(X,Y),Y < 5.

:- use_incremental_dynamic q/2.
:- dynamic q/2.
q(a,1).
q(b,3).
q(c,5).
q(d,7).


end_of_file.

test2:- incr_retractall(q(d,_X)),fail.
test2:- n(X,Y),incr_writeln(third_n(X,Y)),fail.
test2:- incr_retract_inval(q(e,_X)),fail.
test2:- get_residual(n(X,Y),_),incr_writeln(fourth_n(X,Y)),fail.
test2:- incr_table_update,get_residual(n(X,Y),_),incr_writeln(fifth_n(X,Y)),fail.
test2:- incr_assert_inval(q(g,2)),fail.
test2:- get_residual(n(X,Y),_),incr_writeln(sixth_n(X,Y)),fail.
test2:- incr_table_update,get_residual(n(X,Y),_),incr_writeln(seventh_n(X,Y)),fail.
