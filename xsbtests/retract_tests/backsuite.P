
:- import keypair_insert/3, keypair_insert_bt/3,
	keypair_find/2, keypair_delete_bt/2,
	keypair_delete/2
	from back_assert.

%% X is 1
:- keypair_insert(111,f(a),X), write('X='), writeln(X).

%% Y=-1 (this key exists)
:- keypair_insert(111,f(_X), Y), write('Y='), writeln(Y).

%% Y=0
:- keypair_insert(111,f(a), Y), write('Y='), writeln(Y).

%% X=a
:- keypair_find(111,f(X)), write('X='), writeln(X).

%% X=1
%% Temporarily deleted1
:- keypair_delete_bt(111,X),write('X='), writeln(X),
	(keypair_find(111,f(X))->writeln('bug')
	; writeln('temporarily deleted1')
	),
	fail.

%% Still XXX=a, since we failed with keypair_delete_bt
:- keypair_find(111,f(X)), write('XXX='), writeln(X).

%% X=1: succeded
:- keypair_delete_bt(111,X),write('XX='), writeln(X).

%% not found
:- (keypair_find(111,f(X))->writeln('bug1')
   ; writeln('not found')
   ).


%% YY=1
:- keypair_insert(111,f(_X), Y),  write('YY='), writeln(Y).

%% not found1
:- keypair_find(111,g(X))->writeln(bug2); writeln('not found1').

%% ok
:- keypair_find(111,f(_X))->writeln(ok); writeln('bug4').

%% XXXX=1
:- keypair_delete(111,X), write('XXXX='), writeln(X).

%% not found3
:- (keypair_find(111,X)->writeln('bug5')
   ; writeln('not found3')
   ).


%% aaa=kkk
%% Del=1
%% Not found4
:- keypair_insert_bt(aaa,kkk,_),keypair_find(aaa,X),write('aaa='), writeln(X),
	keypair_delete_bt(aaa,Del), write('Del='), writeln(Del),
	(keypair_find(aaa,X)->writeln('bug6')
	; writeln('not found4')
	),
	fail.
%% Not found5
:- (keypair_find(aaa,X)->writeln('bug7')
   ; writeln('not found5')
   ).

:- keypair_insert_bt(aaa,pp,X).

%% aaa=pp
%% Del=1
%% not found6
:- keypair_find(aaa,X), write('aaa='), writeln(X),
	keypair_delete_bt(aaa,Del), write('Del='), writeln(Del),
	(keypair_find(aaa,X)->writeln('bug66')
	; writeln('not found6')
	),
	fail.
%% X=pp
:- (keypair_find(aaa,X)->write('X='),writeln(X)
   ; writeln('bug8')
   ).

%% aaa=pp
%% Del=1
%% Not found9
%% Del2=0 (because aaa was temporarily deleted at this point)
:- keypair_find(aaa,X), write('aaa='), writeln(X),
	keypair_delete_bt(aaa,Del), write('Del='), writeln(Del),
	(keypair_find(aaa,X)->writeln('bug66')
	; writeln('not found9')
	),
	keypair_delete(aaa,Del2), write('Del2='), writeln(Del2),
	fail.

%% aaa=pp (because keypair_delete above didn't do anything, and we then 
% backtreacked erasing all backtrackable changes
:- (keypair_find(aaa,X)->write('aaa='), writeln(X)
   ; writeln('bug99')
   ).


%% aaa=pp
%% Del3=1
%% not found009
%% Del4=0 (because it was previously deleted
:- keypair_find(aaa,X), write('aaa='), writeln(X),
	keypair_delete(aaa,Del), write('Del3='), writeln(Del),
	(keypair_find(aaa,X)->writeln('bug666')
	; writeln('not found009')
	),
	keypair_delete_bt(aaa,Del2), write('Del4='), writeln(Del2),
	fail.

%% not found0
:- (keypair_find(aaa,X)->writeln('bug777')
   ; writeln('not found0')
   ).

