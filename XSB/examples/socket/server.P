
:- import 
     socket/1, socket_bind/2, socket_listen/2, socket_accept/2, 
     socket_connect/4, socket_flush/1, socket_set_option/3,
     socket_close/1 from socket.

:- import file_close/1, fmt_write/3 from file_io.

:- import 
        file_write/2,
        file_write_canonical/2 
        from xsb_writ.

:- import
        file_read_canonical/3 from machine.

%% Port on which the server is listening
xsb_port(6020).

server :-
  socket(Sockfd0),
  writeln(socket(Sockfd0)),
  socket_set_option(Sockfd0,linger,-1),
  xsb_port(XSBPort),
  socket_bind(Sockfd0, XSBPort),
  writeln(socket_bind(Sockfd0, XSBPort)),
  socket_listen(Sockfd0,10),
  writeln(socket_listen(Sockfd0,10)),
  socket_accept(Sockfd0, Sockptr0),
  writeln(socket_accept(Sockfd0, Sockptr0)),
  socket_accept(Sockfd0, Sockptr1), 
  server_loop(Sockptr0, Sockptr1, Sockfd0).


server_loop(Sockptr0, Sockptr1, Sockfd0) :-
    writeln(serverloop1),
    file_read_canonical(Sockptr0, Goal, Psc),
    Psc = Psc,

    writeln(goal(Goal)),
    Goal =.. [F|_Rest],
    (F=end_of_file -> 
	writeln('Client quits...'),
	socket_close(Sockfd0),
	file_close(Sockptr1), file_close(Sockptr0),
	true
    ;	((F=h; F=g) ->
	    call(Goal), writeln(answer(Goal)),
	    file_write_canonical(Sockptr1, Goal),
	    file_write(Sockptr1, '. ')
	;   write('Invalid goal: '), writeln(Goal),
	    %%file_write_canonical(Sockptr1, '+++Invalid goal: '),
	    %%file_write(Sockptr1, '. '),
	    %%file_write(Sockptr1, '    '),
	    %%file_write_canonical(Sockptr1, Goal),
	    fmt_write(Sockptr1, '''+++Invalid goal: %S''', arg(Goal)),
	    file_write(Sockptr1, '. ')
	),
	socket_flush(Sockptr1),
	fail
    ).

  
server_loop(Sockptr0, Sockptr1, Sockfd0) :-
  writeln(serverloop2),
  file_write_canonical(Sockptr1, end),
  file_write(Sockptr1, '. '),
  socket_flush(Sockptr1),
  server_loop(Sockptr0,Sockptr1, Sockfd0).



g(1).
g(2).
g(3).
g(4).
g(5). 



h(a).
h(b).
h(c).
h(d).
h(e).
