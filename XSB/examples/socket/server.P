
:- import 
     socket/1, socket_bind/2, socket_listen/2, socket_accept/2, 
     socket_connect/4, socket_flush/1 from socket.

:- import 
        file_write/2,
        file_write_canonical/2 
        from xsb_writ.

:- import
        file_read_canonical/3 from machine.

machine(sbproud8,'130.245.8.8').
machine(sbproud12,'130.245.18.12').
xsb_port(6020).

server :-
  socket(Sockfd0),
  writeln(socket(Sockfd0)),
  xsb_port(XSBPort),
  socket_bind(Sockfd0, XSBPort),
  writeln(socket_bind(Sockfd0, XSBPort)),
  socket_listen(Sockfd0,10),
  writeln(socket_listen(Sockfd0,10)),
  socket_accept(Sockfd0, Sockptr0),
  writeln( socket_accept(Sockfd0, Sockptr0)),
  socket_accept(Sockfd0, Sockptr1), 
  server_loop(Sockptr0, Sockptr1).
%  server_loop(Sockptr0).


server_loop(Sockptr0, Sockptr1) :-
%server_loop(Sockptr) :-
    writeln(serverloop1),
    file_read_canonical(Sockptr0, Goal, Psc),
%    file_read_canonical(Sockptr, Goal, Psc),
    Psc = Psc,

    writeln(goal(Goal)),
    call(Goal),
    writeln(answer(Goal)),

    file_write_canonical(Sockptr1, Goal),
    file_write(Sockptr1, '. '),
    socket_flush(Sockptr1),
    fail.

  
server_loop(Sockptr0, Sockptr1) :-
%server_loop(Sockptr) :-
  writeln(serverloop2),
  file_write_canonical(Sockptr1, end),
%  file_write_canonical(Sockptr, end),
  file_write(Sockptr1, '. '),
%  file_write(Sockptr, '. '),
  socket_flush(Sockptr1),
%  file_flush(Sockptr),
  server_loop(Sockptr0,Sockptr1).
%  server_loop(Sockptr).



g(1).
g(2).
g(3).
g(4).
g(5). 



h(a).
h(b).
h(c).
h(d).
h(e).
