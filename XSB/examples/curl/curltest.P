:- import slash/1 from machine.
:- import load_page/5, url_properties/2, url_properties/3, get_redir_url/2 from curl.
:- import str_match/5, substring/4, str_cat/3 from string.

test_all :- 
	curldir(CurlDir), slash(Slash), 
	fmt_write_string(OutPath, '%s%sactualoutput', f(CurlDir, Slash)), 
	(path_sysop(isdir, OutPath); path_sysop(mkdir, OutPath)),
	fmt_write_string(CertPath, '%s%scertificates', f(CurlDir, Slash)), 
	test_no_options(OutPath), 
	test_noredir(OutPath), 
	test_http_redir(OutPath), 
	test_html_redir(OutPath), 
	test_secure_crt(OutPath, CertPath), 
	test_nonsecure(OutPath), 
	test_auth(OutPath), 
	test_properties_no_opt(OutPath), 
	test_properties(OutPath), 
	test_properties_auth(OutPath), 
	test_timeout(OutPath).

test_no_options(OutPath) :- 
	open(url('zend.com'),read, X), 
	slash(Slash), fmt_write_string(OutFile, '%s%sno_options.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_noredir(OutPath) :- 
	open(url('zend.com'), read, X, [redirect(false)]),
	slash(Slash), fmt_write_string(OutFile, '%s%sno_redir.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_http_redir(OutPath) :- 
	open(url('zend.com'), read, X, [redirect(true)]),
	slash(Slash), fmt_write_string(OutFile, '%s%shttp_redir.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_html_redir(OutPath) :- 
	open(url('http://www.cs.sunysb.edu/~cse532/'), read, X, [redirect(true)]),
	slash(Slash), fmt_write_string(OutFile, '%s%shtml_redir.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_secure_crt(OutPath, CertPath) :- 
	slash(Slash), 
	fmt_write_string(CertFile, '%s%swebmail.cs.sunysb.edu.crt', f(CertPath, Slash)), 
	open(url('https://webmail.cs.sunysb.edu'), read, X, [secure(CertFile)]),
	fmt_write_string(OutFile, '%s%ssecure_crt.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_nonsecure(OutPath) :- 
	open(url('https://webmail.cs.sunysb.edu'), read, X, [secure(false)]),
	slash(Slash), fmt_write_string(OutFile, '%s%snon_secure.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_auth(OutPath) :- 
	open(url('http://twitter.com/direct_messages.xml'), read, X, [auth('curl_test', 'test123')]),
	slash(Slash), fmt_write_string(OutFile, '%s%sauth.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_timeout(OutPath) :- 
	open(url('http://www.xboxliveaddicts.co.uk/forums/index.php?showtopic=23902'), read, X, [timeout(150)]), 
	slash(Slash), fmt_write_string(OutFile, '%s%stimeout.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

test_properties_no_opt(OutPath) :-
	url_properties(url('https://webmail.cs.sunysb.edu/cgi-bin/openwebmail/openwebmail.pl'), [DirEnc, FileUnEnc, Size, ModifyTime]), 
	slash(Slash), fmt_write_string(OutFile, '%s%sprop_no_opt.txt', f(OutPath, Slash)),
	tell(OutFile), 
	writeln('test_url_properties_no_opt on https://webmail.cs.sunysb.edu/cgi-bin/openwebmail/openwebmail.pl'), 
	write('Directory = '), writeln(DirEnc), 
	write('File = '), writeln(FileUnEnc), 
	write('Size = '), writeln(Size), 
	write('Modified Time = '), writeln(ModifyTime), 
	told.

test_properties(OutPath) :-
	url_properties(url('http://www.cs.sunysb.edu/~cse532/'), [redirect(false)], [DirEnc, FileUnEnc, Size, ModifyTime]), 
	slash(Slash), fmt_write_string(OutFile, '%s%sproperties.txt', f(OutPath, Slash)),
	tell(OutFile), 
	write(test_url_properties), writeln(' on http://www.cs.sunysb.edu/~cse532/ where url body is not loaded'), 
	write('Directory = '), writeln(DirEnc), 
	write('File = '), writeln(FileUnEnc), 
	write('Size = '), writeln(Size), 
	write('Modified Time = '), writeln(ModifyTime), 
	told.

test_properties_auth(OutPath) :-
	url_properties(url('http://twitter.com/direct_messages.xml'), [auth('curl_test', 'test123')], [DirEnc, FileUnEnc, Size, ModifyTime]), 
	slash(Slash), fmt_write_string(OutFile, '%s%sprop_auth.txt', f(OutPath, Slash)),
	tell(OutFile), 
	write(test_url_properties_auth), writeln(' on http://twitter.com/direct_messages.xml'), 
	write('Directory = '), writeln(DirEnc), 
	write('File = '), writeln(FileUnEnc), 
	write('Size = '), writeln(Size), 
	write('Modified Time = '), writeln(ModifyTime), 
	told.

test_get_redir_url :-
	get_redir_url(url('http://www.cs.sunysb.edu/~cse532/'), UrlNew1), 
	writeln(UrlNew1), 
	get_redir_url(file('test.html'), UrlNew2), 
	writeln(UrlNew2).

/*Not added to the test suite. This is supposed to throw an error*/
test_secure :- 
	curldir(CurlDir), slash(Slash), 
	fmt_write_string(OutPath, '%s%sactualoutput', f(CurlDir, Slash)), 
	(path_sysop(isdir, OutPath); path_sysop(mkdir, OutPath)),
	open(url('https://webmail.cs.sunysb.edu'), read, X),
	slash(Slash), fmt_write_string(OutFile, '%s%ssecure.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

/*Not added to the test suite. This is supposed to throw an error*/
test_wrong_url :- 
	curldir(CurlDir), slash(Slash), 
	fmt_write_string(OutPath, '%s%sactualoutput', f(CurlDir, Slash)), 
	(path_sysop(isdir, OutPath); path_sysop(mkdir, OutPath)),
	open(url('wrong_url'), read, X),
	slash(Slash), fmt_write_string(OutFile, '%s%swrong_url.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

/*Not added to the test suite. This is supposed to throw an error*/
test_timeout_fail :- 
	curldir(CurlDir), slash(Slash), 
	fmt_write_string(OutPath, '%s%sactualoutput', f(CurlDir, Slash)), 
	(path_sysop(isdir, OutPath); path_sysop(mkdir, OutPath)),
	open(url('http://www.xboxliveaddicts.co.uk/forums/index.php?showtopic=23902'), read, X, [timeout(1)]), 
	slash(Slash), fmt_write_string(OutFile, '%s%stimeout_fail.html', f(OutPath, Slash)),
	tell(OutFile), write_page(X), told,  
	close(X).

write_page(X) :- file_read_line(X, Y), writeln(Y), write_page(X).
write_page(_) :- !.

curldir(CurlDir) :-
        xsb_configuration(install_dir, PackDir),
        slash(Slash),
        fmt_write_string(CurlDir, '%s%sexamples%scurl',
        f(PackDir, Slash, Slash)).

