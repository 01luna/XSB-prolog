/* File:      unix.P
** Author(s): Kostis F. Sagonas, Jiyang Xu
** Contact:   xsb-contact@cs.sunysb.edu
** 
** Copyright (C) The Research Foundation of SUNY, 1986, 1993-1998
** Copyright (C) ECRC, Germany, 1990
** 
** XSB is free software; you can redistribute it and/or modify it under the
** terms of the GNU Library General Public License as published by the Free
** Software Foundation; either version 2 of the License, or (at your option)
** any later version.
** 
** XSB is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
** FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for
** more details.
** 
** You should have received a copy of the GNU Library General Public License
** along with XSB; if not, write to the Free Software Foundation,
** Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
**
** $Id: unix.P,v 1.3 1999/04/10 14:09:09 kostis Exp $
** 
*/


unix(Command) :- 
	term_type(Command, T),
	( T =:= 3 -> constr_command(Command, Command1), unix(Command1, Res)
	; T =:= 5 -> unix(Command, Res)
	),
	Res =:= 0.

constr_command([H], H).
constr_command([H|T], String) :-
	constr_command(T, SubString),
	str_cat(H, SubString, String).
	
unix(Command, Result) :-
	term_type(Command, T),
	( T =:= 5 -> sys_system(1, Command, R, _), Result = R
	; T =:= 1 -> term_psc(Command, PSC), psc_name(PSC, RCommand), 
		     sys_system(1, RCommand, R, _), Result = R
	).

/* Fails, if we can't open stream to/from the system command Command 
** in mode Mode. Mode can be `read' or `write', as in open/3
*/
open_process_stream(Command, Mode, Stream) :-
	term_type(Command, T),
	( T =:= 5 -> sys_system(2, Command, Mode, FileDes), 
	    conpsc(Command,PSC), Stream = Command
	; T =:= 1 -> term_psc(Command, PSC), psc_name(PSC, Stream), 
	    sys_system(2, Stream, Mode, FileDes)
	),
	psc_set_prop(PSC, FileDes),
	psc_set_type(PSC, 5).

%% Same as open_process_stream, bt operates with file descriptors
open_process_pipe(Command, Mode, FileDes) :-
	term_type(Command, T),
	( T =:= 5 -> sys_system(2, Command, Mode, FileDes)
	; T =:= 1 -> term_psc(Command, PSC), psc_name(PSC, RCommand), 
	    sys_system(2, RCommand, Mode, FileDes)
	).

close_process_stream(Stream, RetCode) :-
	conpsc(Stream, PSC),
	psc_type(PSC, Type), Type=5,
	psc_prop(PSC, FileDes), 
	sys_system(3, FileDes,RetCode,_),
	psc_set_type(PSC, 0).

%% Same as close_process_stream, bt operates with file descriptors
close_process_pipe(FileDes, RetCode) :-
	sys_system(3, FileDes,RetCode,_).

cd(Path) :- 
	( atom(Path) -> 
		expand_filename(Path, Dir), sys_chdir(Dir, Res), Res=:=0
	; var(Path) ->
		abort('Uninstantiated argument 1 of cd/1')
	; abort('Wrong type in argument 1 of cd/1')
	).

rename(Old, New) :- sys_rename(Old, New, Res), Res =:= 0.

ls :- unix('ls -F', Res), Res =:= 0.

rm(Name) :- sys_unlink(Name, Res), Res =:= 0.

edit(File) :- 
	expand_filename(File, FileName), 
	unix(['$EDITOR ', '$EDITOR_OPTIONS ', FileName, '.P']).

/*
sys_exit() :- sys_syscall(1).
 */
sys_link(Source, Dest, Res) :-	sys_syscall(  9, Res, Source, Dest).
sys_unlink(Path, Res) 	    :-	sys_syscall( 10, Res, Path).
sys_chdir(Dir, Res)	    :- 	sys_syscall( 12, Res, Dir).
sys_access(File, Mode, Res) :- 	sys_syscall( 33, Res, File, Mode).
sys_stat(Path, Buff, Res)   :-	sys_syscall( 38, Res, Path, Buff).
sys_rename(Old, New, Res)   :-	sys_syscall(128, Res, Old, New).


/*
sys_syscall(_CallNo, _Res)				 :- '_$builtin'(55).
 */
sys_syscall(_CallNo, _Res, _A1)				 :- '_$builtin'(55).
sys_syscall(_CallNo, _Res, _A1, _A2)			 :- '_$builtin'(55).
/*
sys_syscall(_CallNo, _Res, _A1, _A2, _A3)		 :- '_$builtin'(55).
sys_syscall(_CallNo, _Res, _A1, _A2, _A3, _A4)		 :- '_$builtin'(55).
sys_syscall(_CallNo, _Res, _A1, _A2, _A3, _A4, _A5)	 :- '_$builtin'(55).
sys_syscall(_CallNo, _Res, _A1, _A2, _A3, _A4, _A5, _A6) :- '_$builtin'(55).
 */
