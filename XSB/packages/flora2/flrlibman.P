/* File:      flrlibman.P -- Flora includes and libraries definitions
**
** Author(s): Guizhen Yang
**
** Contact:   xsb-contact@cs.sunysb.edu
**
** Copyright (C) The Research Foundation of SUNY, 1999-2001
**
** XSB is free software; you can redistribute it and/or modify it under the
** terms of the GNU Library General Public License as published by the Free
** Software Foundation; either version 2 of the License, or (at your option)
** any later version.
**
** XSB is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
** FOR A PARTICULAR PURPOSE.  See the GNU Library General Public License for
** more details.
**
** You should have received a copy of the GNU Library General Public License
** along with XSB; if not, write to the Free Software Foundation,
** Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
**
**
*/


:- compiler_options([xpp_on]).


#include "flora_terms.flh"


/**********************************************************************
  flora_register_syslib(+LibBaseFile)
**********************************************************************/
flora_register_syslib(LibBaseFile) :-
	var(LibBaseFile),
	!,
	flora_error_line('Uninstantiated FLORA system library name! Registration aborted!'),
	abort.

flora_register_syslib(LibBaseFile) :-
	assert(flora_syslib_loaded(LibBaseFile)).


/**********************************************************************
  flora_load_library(+List)
  flora_load_library(+Atom)

  Note: This predicate always succeeds.
**********************************************************************/
flora_load_library(LibName) :-
	var(LibName),
	!,
	flora_error_line('Unbound FLORA library name - Loading aborted!'),
	abort.

flora_load_library([]) :- !.

flora_load_library([H|T]) :-
	!,
	flora_load_library(H),
	flora_load_library(T).

flora_load_library(LibID) :-
	flora_library(LibID,LibFile,BaseFilename),
	!,
	( flora_syslib_loaded(BaseFilename) -> true
	;
	    package_configuration(dir(flora),FloraDir),
	    slash(S),
	    fmt_write_string(FullLibPath,"%s%s%s",args(FloraDir,S,LibFile)),
	    %% Because LibID -> BaseFilename, we register base filename rather
	    %% than the library ID (several LibId can correspond to one file.
	    flora_register_syslib(BaseFilename),
	    consult(FullLibPath)
        ).

flora_load_library(_LibID).


/********************************************************************
  flora_include(+Atom,+FilePath)
  indicates which file to be included in the output file.
********************************************************************/
flora_include(LibId,IncFile) :-
	atom(LibId),
	slash(S),
	flora_library_file(LibId,BaseFilename,Dir),
	!,
	fmt_write_string(IncFile,'%sinc%s%s_inc.flh', arg(Dir,S,BaseFilename)).

/********************************************************************
  flora_library(+Atom,-FilePath,-Basefilename)
  indicates which library to be loaded.
********************************************************************/
flora_library(LibId,LibFile,BaseFilename) :- 
	atom(LibId),
	slash(S),
	flora_library_file(LibId,BaseFilename,Dir),
	!,
	fmt_write_string(LibFile,'%s%s%s.P',arg(Dir,S,BaseFilename)).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

/****************************************************************************
  Flora libraries
*****************************************************************************/

flora_library_file(FLLIBMIN,flraggmin,syslib) :- !.
flora_library_file(FLLIBMAX,flraggmax,syslib) :- !.
flora_library_file(FLLIBSUM,flraggsum,syslib) :- !.
flora_library_file(FLLIBAVG,flraggavg,syslib) :- !.
flora_library_file(FLLIBCOUNT,flraggcount,syslib) :- !.
flora_library_file(FLLIBCOLLECTSET,flraggcolset,syslib) :- !.
flora_library_file(FLLIBCOLLECTBAG,flraggcolbag,syslib) :- !.
flora_library_file(FLLIBLOAD,flrload,syslib) :- !.
flora_library_file(FLLIBANSWER,flranswer,syslib) :- !.
flora_library_file(FLLIBSHELLANS,flranswer,syslib) :- !.
flora_library_file(FLLIBPROGRAMANS,flranswer,syslib) :- !.
flora_library_file(FLLIBDISPLAY,flrdisplay,syslib) :- !.
flora_library_file(FLLIBDBOP,flrdbop,syslib) :- !.
flora_library_file(FLLIBINSERT,flrdbop,syslib) :- !.
flora_library_file(FLLIBINSERTALL,flrdbop,syslib) :- !.
flora_library_file(FLLIBDELETE,flrdbop,syslib) :- !.
flora_library_file(FLLIBDELETEALL,flrdbop,syslib) :- !.
flora_library_file(FLLIBERASE,flrdbop,syslib) :- !.
flora_library_file(FLLIBERASEALL,flrdbop,syslib) :- !.
flora_library_file(FLLIBBTDBOP,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTINSERT,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTINSERTALL,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTDELETE,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTDELETEALL,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTERASE,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBBTERASEALL,flrbtdbop,syslib) :- !.
flora_library_file(FLLIBSHDIRECT,flrshdirect,syslib) :- !.
flora_library_file(FLLIBDYNMOD,flrdynmod,syslib) :- !.
flora_library_file(FLLIBMODLIT,flrdynmod,syslib) :- !.
flora_library_file(FLLIBMODOBJ,flrdynmod,syslib) :- !.
flora_library_file(FLLIBEQUALITY,flrequality,syslib) :- !.
flora_library_file(FLLIBEXPUNGE,flrexpunge,syslib) :- !.
flora_library_file(FLLIBCONTROL,flrcontrol,syslib) :- !.

/**************************************************************************
  Flora headers
***************************************************************************/
flora_library_file(FLHEADER,flrheader,header) :- !.
flora_library_file(FLDEFINITION,flrdefinition,header) :- !.
flora_library_file(FLPATCH,flrpatch,header) :- !.
flora_library_file(FLTRAILER,flrtrailer,header) :- !.
flora_library_file(FLEQLTRAILER,flreqltrailer,header) :- !.
flora_library_file(FLSCALAREQL,flrscalareql,header) :- !.

%% Arg1: service code; Arg2: base file name of the service library
flora_library_file(ServiceId,ServiceBaseFile, Dir) :-
	flora_service_file(ServiceId,ServiceBaseFile, Dir), !.

%% Catchall
flora_library_file(S,F,_) :-
	flora_error_line("Unknown library Id `%S' or file `%S'", args(S,F)),
	abort.


/*****************************************************************************
   Flora services
*****************************************************************************/

flora_service_file(FLSERVPP, flrprettyprint, lib) :- !.
flora_service_file(FLSERVIO, flrio, lib) :- !.
