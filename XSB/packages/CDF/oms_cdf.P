:- compiler_options([ciao_directives]).

:- import abolish_table_pred/1 from tables.

:- dynamic oms_dirty/1.
:- index(oms_dirty/1,0,0).
:- make_oms_clean.
make_oms_dirty :- retractall(oms_dirty(_)),asserta(oms_dirty(1)).
make_oms_clean :- retractall(oms_dirty(_)),asserta(oms_dirty(0)).

:- comment(oms_update_list/1, "oms_update_list takes a list of
assert/retracts to stored OMS relations and executes them.  All
updates to any OMS relation should go through here.  This will
allow to keep the external DB consistent, when we get to it.").

oms_update_list(List) :-
	oms_do_update_list(List).

oms_do_update_list([]).
oms_do_update_list([Term|Terms]) :-
	oms_update_term(Term),
	oms_do_update_list(Terms).

oms_update_term(asserta(Term)) :-
	assert_oms(Term),
	oms_dirty(DFlg),
	(DFlg =:= 1
	 ->	true
	 ;	make_oms_dirty
	).
oms_update_term(retractall(Term)) :- retractall_oms(Term).

:- import call_c/1 from standard.
retractall_oms(oms_rln(A,B,C)) :- !,
	Term = oms_rln(A,B,C),
	retractall(Term),
	oms_dirty(DFlg),
	(DFlg =:= 1
	 ->	true
	 ;	make_oms_dirty
	),
	abolish_relationship_inherits.
retractall_oms(oms_schrel(A,B,C)) :- !,
	Term = oms_schrel(A,B,C),
	retractall(Term),
	oms_dirty(DFlg),
	(DFlg =:= 1
	 ->	true
	 ;	make_oms_dirty
	),
	abolish_schrel_inherits.
retractall_oms(oms_sc(A,B)) :- !,
	Term = oms_sc(A,B),
	retractall(Term),
	oms_dirty(DFlg),
	(DFlg =:= 1
	 ->	true
	 ;	make_oms_dirty
	),
	abolish_relationship_inherits,
	abolish_schrel_inherits.
retractall_oms(Term) :-
	retractall(Term),
	oms_dirty(DFlg),
	(DFlg =:= 1
	 ->	true
	 ;	make_oms_dirty
	).


